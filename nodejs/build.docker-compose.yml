services:
  node-builder:
    image: node:20-alpine
    container_name: edu-node-builder
    working_dir: /app
    volumes:
      - /root/www/edu_rag_platform_ui:/app        
      - /tmp/yarn:/tmp/yarn:ro                     
      - yarn-cache:/usr/local/share/.cache/yarn/berry
      - /root/www/docker_relation_server/nginx/dist:/app/dist
    environment:
      - NODE_ENV=production
      - BUILD_PRO=true
      - BUILD_OUT_DIR=/tmp/dist
      - VITE_API_URL=http://106.12.58.7:8000/edu_rag/api
      - COREPACK_ENABLE_DOWNLOAD_PROMPT=0
      - YARN_NPM_REGISTRY_SERVER=https://registry.npmmirror.com
      - YARN_HTTP_TIMEOUT=120000
    command: |
      sh -c "
        mkdir -p /usr/local/share/.corepack/yarn/4.12.0 &&
        cp /tmp/yarn/yarn.cjs /usr/local/share/.corepack/yarn/4.12.0/yarn.js &&
        corepack enable &&
        yarn install --immutable &&
        yarn build:pro &&
        echo 'âœ… turbo build finished '
      "

volumes:
  yarn-cache: