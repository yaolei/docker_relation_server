services:
  node-builder:
    image: node:20-alpine
    container_name: edu-node-builder
    working_dir: /app
    volumes:
      - /root/www/edu_rag_platform_ui:/app
      
      # 挂载 corepack 目录
      - /usr/lib/node_modules/corepack:/usr/lib/node_modules/corepack:ro
      
      # 挂载 yarn 缓存目录
      - /root/.yarn:/root/.yarn:rw
      - /root/.cache/yarn:/root/.cache/yarn:rw
      
      - /root/www/docker_relation_server/nginx/dist:/app/dist
      
    environment:
      - NODE_ENV=production
      - BUILD_PRO=true
      - BUILD_OUT_DIR=/app/dist
      - VITE_API_URL=http://106.12.58.7:8000/edu_rag/api
      - YARN_NPM_REGISTRY_SERVER=https://registry.npmmirror.com
      - YARN_HTTP_TIMEOUT=120000
      
    command: |
      sh -c "
        # 使用 Node.js 直接执行宿主机的 yarn.js
        YARN_JS=/usr/lib/node_modules/corepack/dist/yarn.js
        
        # 验证
        echo '=== 环境验证 ==='
        echo "使用 yarn.js 路径: $YARN_JS"
        echo 'Node 版本:'
        node --version
        echo 'Yarn 版本:'
        node $YARN_JS --version
        
        # 执行构建
        echo '=== 开始构建 ==='
        node $YARN_JS install --immutable
        node $YARN_JS build:pro
        
        # 复制文件
        echo '=== 复制文件 ==='
        rm -rf /app/dist/*
        cp -r apps/shell/dist/* /app/dist/
        cp -r apps/edu-admin-app/dist /app/dist/admin
        
        echo '✅ 构建完成'
      "